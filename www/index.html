<!DOCTYPE html PUBLIC>
<html lang="en-GB">
<head>
  <title>Ticker Demo ~ Chris Kemp
  </title>
  <meta http-equiv="content-type" content="text/html">
  <meta name="description" content="">
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <div id="body" class="body shadow">
    <div id="header" class="body__header">
      <h1 class="body__header--text">Kemp Ticker
      </h1>

    </div>
    <div id="content" class="body__content">
      <h2>Sample Ticker
      </h2>
      <p>Keep up to date and ahead of the game by pulling your figures straight from the stock markets with <em>Kemp Ticker
      </em> &reg;.
    </p>
    <h3>Stats
    </h3>
    <div id="stats" class="stats">
      <table>
        <thead>
          <tr>
            <th class="name">Name</th>
            <th>Company Name</th>
            <th class="number">Price</th>
            <th class="number">Change</th>
            <th class="number">Chg %</th>
            <th class="number">Mkt Cap</th>
          </tr>
        </thead>
        <tbody>
          <tr id="ROW_{{Name}}">
            <th class="name">{{Name}}</th>
            <td class="companyName">{{Company Name}}</span></td>
            <td class="number price"><span>{{Price}}</span></td>
            <td class="number change"><span>{{Change}}</span></td>
            <td class="number changePercent"><span>{{Change %}}</span></td>
            <td class="number marketCap"><span>{{Mkt Cap}}</span></td>
          </tr>
        </tbody>
      </table>
      <button type="button" id="startButton" disabled>Start</button>
      <button type="button" id="stopButton" disabled>Stop</button>
    </div>
    <h3>Graph</h3>
  </div>
  <!--
  <div id="footer" class="body__footer">
    <p class="body__footer--text">This is the footer</p>
  </div>
  -->
</div>
<script type="text/javascript" src="ticker.js"></script>
<script type="text/javascript">
  (function() {
    "use strict";

    function addClass(e, c) {
      removeClass(e, c);
      e.className = (e.className + " " + c).trim();
    }

    function removeClass(e, c) {
      if (typeof e.className === "undefined") return;
      var classes = e.className.split(" ");
      var r = [];
      for (var i=0,j=classes.length;i<j;i++)
        if (classes[i] !== c)
          r.push(classes[i])
      e.className = r.join(" ");
    }

    function replaceCell(e, s) {
      addClass(e, "animOut");
      e.setAttribute("data-text", s);
    }

    function listenForAnimEnd(anim) {
      var e = anim.target;
      if (anim.animationName === "flipOutX") {
        e.innerText = e.getAttribute("data-text");
        e.removeAttribute("data-text");
        removeClass(e, "animOut");
        addClass(e, "animIn");
      } else {
        removeClass(e, "animIn");
      }
    }

    window.onload = function() {

      console.log("resources loading...");
      ticker.initialise(function(engine) {

        var tbody = document.querySelector("#stats tbody");
        var tableHtml = "";
        var template = tbody.innerHTML;
        for (var i=0,j=engine.snapshots.length;i<j;i++) {
          var snapshot = engine.snapshots[i];
          tableHtml += template
            .replace(/{{Name}}/g, snapshot.name)
            .replace("{{Company Name}}", snapshot.companyName)
            .replace("{{Price}}", snapshot.price)
            .replace("{{Change}}", snapshot.change)
            .replace("{{Change %}}", snapshot.changePercent)
            .replace("{{Mkt Cap}}", snapshot.marketCap);
        }
        tbody.innerHTML = tableHtml;

        // animation
        var items = document.querySelectorAll("#stats td span");
        for (var i=0,j=items.length;i<j;i++) {
          items[i].addEventListener("animationend", listenForAnimEnd, false);
        }

        var startButton = document.getElementById("startButton");
        var stopButton = document.getElementById("stopButton");

        engine.onchange = function(s, changes) {
          window.requestAnimationFrame(function() {
            console.log(s.name, changes);
            for (var i=0,j=changes.length;i<j;i++) {
              var e = document.querySelector("#ROW_" + s.name + " ." + changes[i] + " span");
              replaceCell(e, s[changes[i]]);
            }
          });
        };

        engine.onstart = function(e) {
          console.log("onstart");
          startButton.setAttribute("disabled", "");
          stopButton.removeAttribute("disabled");
        }

        engine.onstop = function(e) {
          console.log("onstop");
          startButton.removeAttribute("disabled");
          stopButton.setAttribute("disabled", "");
        }

        startButton.onclick = function(e) {
          e.target.setAttribute("disabled", "");
          engine.start();
        }

        stopButton.onclick = function(e) {
          e.target.setAttribute("disabled", "");
          engine.stop();
        };

        engine.start();
        console.log("resources loaded....");
      });
    };

  })();

</script>
</body>
</html>
